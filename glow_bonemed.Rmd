---
title: "glow_bonemed EDA"
author: "Derek Rogers, "
date: "2023-04-04"
output: 
  html_document:
    theme: cerulean
    fontsize: 16pt
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(aplore3)
library(ggplot2)
library(dplyr)
library(plotly)
library(ca)
library(RColorBrewer)
library(pheatmap)
library(cluster)
library(ggcorrplot)
library(dplyr)
library(tidyr)
library(sjPlot)
library(sjmisc)
library(caret)
library(vcd)
library(FactoMineR)
```

```{r}
#??glow500
```

Data Format: A data.frame with 500 rows and 18 variables such as:

priorfrac - If the patient previously had a fracture<br>
age - Age at Enrollment (years)<br>
weight - Weight at enrollment (Kilograms)<br>
height - Height at enrollment (Centimeters)<br>
bmi - Body Mass Index (Kg/m^2)<br>
premeno - Menopause before age 45 (1: No, 2: Yes)<br>
momfrac - Mother had hip fracture (1: No, 2: Yes)<br>
armassist - Arms are needed to stand from a chair (1: No, 2: Yes)<br>
smoke - Former or current smoker (1: No, 2: Yes)<br>
raterisk - Self-reported risk of fracture (1: Less than others of the same age, 2: Same as others of the same age, 3: Greater than others of the same age<br>
fracscore - Fracture Risk Score (Composite Risk Score)<br>
fracture - Any fracture in first year (1: No, 2: Yes)<br>
bonemed - Bone medications at enrollment (1: No, 2: Yes)<br>
bonemed_fu - Bone medications at follow-up (1: No, 2: Yes)<br>
bonetreat - Bone medications both at enrollment and follow-up (1: No, 2: Yes)<br>

```{r}
head(glow_bonemed)
```

Summary statistics for numeric variables

```{r, message=FALSE, warning=FALSE}
#Set fracscore to integer for summary statistics
glow_bonemed$fracscore = as.integer(glow_bonemed$fracscore)
mysummary = glow_bonemed %>%
  select(age, weight, height, bmi, fracscore) %>%
  summarise_each(
    funs(min = min, 
    q25 = quantile(., 0.25), 
    median = median, 
    q75 = quantile(., 0.75), 
    max = max,
    mean = mean, 
    sd = sd,
    variance= var))

# reshape it using tidyr functions

clean.summary = mysummary %>% 
  gather(stat, val) %>%
  separate(stat, into = c("var", "stat"), sep = "_") %>%
  spread(stat, val) %>%
  select(var, min, max, mean, sd, variance)

print(clean.summary)
```

Summary statistics for categorical variables

```{r}
summary(glow_bonemed %>% select(priorfrac, premeno, momfrac, armassist, smoke, raterisk, fracture, bonemed, bonemed_fu, bonetreat))
```

No missing values

```{r}
colSums(is.na(glow_bonemed))
sum(is.na(glow_bonemed))
```

Age vs Weight: As weight increases the average age decreases<br>
Age vs Height: Weak correlation of as height increases age decreases<br>
Age vs BMI: As bmi increases the average age decreases<br>
Age vs fracscore: As age increases the average fracscore increases<br>

Weight vs Height: As height increases the average weight increases<br>
Weight vs BMI: As bmi increases the average weight increases<br>
Weight vs fracscore: As fracscore increases the average Weight decreases<br>

Height vs BMI: As bmi increases the average height and variance stay the same<br>
Height vs fracscore: As fracscore increases the average height stays the same though variance might decrease<br>

BMI vs fracscore: As fracscore increases the average bmi decreases<br>

```{r}
plot(glow_bonemed[, c(5:8, 14)])
```

Non of the following scatter plots show strong groupings for the fracture/no fracture categorical variable
```{r}
ggplot(glow_bonemed, aes(x = age, y = bmi, color = fracture)) +
  geom_jitter() +
  labs(title = "BMI vs Age")
```
```{r}
ggplot(glow_bonemed, aes(x = bmi, y = fracscore, color = fracture)) +
  geom_jitter() +
  labs(title = "Fracture Score vs BMI")
```

```{r}
ggplot(glow_bonemed, aes(x = fracscore, y = age, color = fracture)) +
  geom_jitter() +
  labs(title = "Age vs Fracture Score")
```

```{r}
ggplot(glow_bonemed, aes(x = weight, y = height, color = fracture)) +
  geom_jitter() +
  labs(title = "Height vs Weight")
```

Once again there doesn't seem to be strong groupings of the fracture categorical variable

```{r, message=FALSE, warning=FALSE}
fracture3dplot = plot_ly(glow_bonemed, 
  x = ~age, 
  y = ~height, 
  z = ~bmi, 
  color = ~fracture, 
  colors = c('#0C4B8E', '#BF382A')) %>% add_markers()

fracture3dplot
```

There are so little "yes" fracture results that the plot isn't very useful

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(glow_bonemed, aes(x = bmi, y = fracscore, colour = fracture)) + 
  geom_point() +
  geom_smooth(method = "loess", size = 1, span = 0.75) +
  ylim(-0.2, 1.2)
```

```{r, echo=FALSE}
ggplot(glow_bonemed, aes(x = bmi, y = age, colour = raterisk)) +
  geom_point() +
  geom_smooth(method = "loess", linewidth = 1, span = 0.75) +
  facet_wrap(~raterisk)
```

The boxplot shows that the mean fracscore seems to be slightly higher for smokers compared to non smokers

```{r}
ggplot(glow_bonemed, aes(x = smoke, y = fracscore)) +
  geom_boxplot() +
  labs(title = "Fracture Score Summary Statistics for Smokers vs Non Smokers")
```

Plot confirms there is a strong correlation between age/fracscore, bmi/weight

```{r}
corr_vars <- c("age", "weight", "height", "bmi", "fracscore")

corr_df <- glow_bonemed[, corr_vars]
corr_df <- cor(corr_df)

ggcorrplot(corr = corr_df, lab = TRUE, lab_size = 2,
  colors = c("#6D9EC1", "white", "#E46726")) +
  labs(title = "Correlation Between Variables") +
  theme(plot.title = element_text(hjust = .5),
  plot.subtitle = element_text(hjust = .5))
```

# Categorical Variable EDA

```{r}
mosaicplot(table(glow_bonemed$priorfrac, glow_bonemed$fracture), color = TRUE)
```

```{r}
chisq.test(table(glow_bonemed$priorfrac, glow_bonemed$fracture))
```

Perform chi-squared test on all categorical variables

```{r}
glow_bonemed$fracscore = as.factor(glow_bonemed$fracscore)

blow_bonemed_categoricals = glow_bonemed[, c(4, 9:18)]

multipleCorrespondenceAnalysis = MCA(blow_bonemed_categoricals, quali.sup = "fracture", graph = FALSE)
multipleCorrespondenceAnalysis
```

All of the categorical variables seem to have significant P values with bonetreate, bonemed, and bonemed_fu all having R^2 above .83

```{r}
firstDimension = dimdesc(multipleCorrespondenceAnalysis, axes = 1)
firstDimension
```

bonetreat, bonemed, bonemed_fu all have a sensitivity around 78% and specificity between 32% and 42%

```{r}
confusionMatrix(table(glow_bonemed$bonetreat, glow_bonemed$fracture)) 
confusionMatrix(table(glow_bonemed$bonemed, glow_bonemed$fracture))
confusionMatrix(table(glow_bonemed$bonemed_fu, glow_bonemed$fracture))
```

```{r}
glow_bonemed$fracscore = as.factor(glow_bonemed$fracscore)

blow_bonemed_categoricals = glow_bonemed[, c(15:18)]

multipleCorrespondenceAnalysis = MCA(blow_bonemed_categoricals, graph = FALSE)

plot.MCA(multipleCorrespondenceAnalysis, 
         cex = 0.8, 
         col.quali.sup = c("red", "blue", "green"), 
         title = "Multiple Correspondence Analysis")
```

# Clustering EDA

```{r}
pheatmap(glow_bonemed[, c(5,8)], scale = "column", fontsize_row = 0.1, cluster_cols = F, legend = T, color = colorRampPalette(c("blue", "white", "red"), space = "rgb")(100))
```

```{r}
pheatmap(glow_bonemed[, 5:8], scale = "column", fontsize_row = 0.1, cluster_cols = F, legend = T, color = colorRampPalette(c("blue", "white", "red"), space = "rgb")(100))
```

```{r}
zScoreScale = scale(glow_bonemed[, 5:8])

zScoreDistance = dist(zScoreScale)

continuousVariableClustering = hclust(zScoreDistance, method = "complete")

plot(continuousVariableClustering)
```

# Modeling

Split the data into a training/testing set

```{r}
set.seed(4)

trainingIndices = sample(c(1:dim(glow_bonemed)[1]), dim(glow_bonemed)[1]*0.8)

trainingDataframe = glow_bonemed[trainingIndices,]
testingDataframe = glow_bonemed[-trainingIndices,]
```

Age is the only statistically significant continuous variable at the alpha = 0.2 level (p < 0.0001)

```{r}
model = glm(fracture ~ age + weight + height + bmi, data = glow_bonemed[trainingIndices,], family = "binomial")

summary(model)

AIC(model)
```

```{r}
# trying to figure out how to use sjPlot to mimic what we did in unit12 prelive
#plot_model(model, type = "pred", terms = c("age", "smoke"))
```

Get eigen vectors and values for principle component analysis

```{r}
glow_bonemed$fracscore = as.integer(glow_bonemed$fracscore)
corr_vars <- c("age", "weight", "height", "bmi", "fracscore")
pc.result<-prcomp(glow_bonemed[, corr_vars],scale.=TRUE)

#Eigen Vectors
pc.result$rotation

#Eigen Values
eigenvals<-pc.result$sdev^2
eigenvals
```

Scree plot

```{r}
par(mfrow = c(1, 2))

plot(eigenvals,type = "l",
     main = "Scree Plot",
     ylab = "Eigen Values",
     xlab = "PC #")

plot(eigenvals / sum(eigenvals), 
     type = "l", main = "Scree Plot", 
     ylab = "Prop. Var. Explained", 
     xlab = "PC #", 
     ylim = c(0, 1))

cumulative.prop = cumsum(eigenvals / sum(eigenvals))

lines(cumulative.prop, lty = 2)
```

Naive Bayes model with categorical variables

```{r}
corr_vars <- c("priorfrac", "premeno", "momfrac", "armassist", "smoke", "raterisk", "fracture", "bonemed", "bonemed_fu", "bonetreat")

set.seed(1234)
fitControl = trainControl(method = "repeatedcv", number = 10, repeats = 1)
nb.fit = train(fracture ~ .,
               data = trainingDataframe[, corr_vars],
               method = "nb",
               trControl = fitControl
               )
nb.fit
```


Knn models

```{r}
corr_vars <- c("age", "weight", "height", "bmi", "fracscore", "fracture")

set.seed(1234)
fitControl = trainControl(method = "repeatedcv", number = 10, repeats = 1)
knn.fit = train(fracture ~ .,
               data = trainingDataframe[, corr_vars],
               method = "knn",
               trControl = fitControl,
               tuneGrid = expand.grid(k = c(1:10, 20, 30))
               )
knn.fit
```

After tinkering it seems the best model only uses the age variable

```{r}
corr_vars <- c("age", "weight", "height", "bmi", "fracscore", "fracture")

set.seed(1234)
fitControl = trainControl(method = "repeatedcv", number = 10, repeats = 1)
knn.fit = train(fracture ~ age,
               data = trainingDataframe[, corr_vars],
               method = "knn",
               trControl = fitControl,
               tuneGrid = expand.grid(k = c(1:10, 20, 30))
               )
knn.fit
```

#Sources:<br>
  Hosmer, D.W., Lemeshow, S. and Sturdivant, R.X. (2013) Applied Logistic Regression, 3rd ed.,
  New York: Wiley
  
  https://cran.r-project.org/web/packages/aplore3/aplore3.pdf#page=11&zoom=100,132,90